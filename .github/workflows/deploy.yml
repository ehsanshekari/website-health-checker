name: Deploy to AWS

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  deploy:
    name: Deploy Lambda to AWS
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Log configured AWS region
        run: |
          echo "Workflow AWS_REGION=${{ vars.AWS_REGION }}"
          echo "Environment AWS_REGION=$AWS_REGION"

      - name: Install AWS CLI if missing
        run: |
          if ! command -v aws >/dev/null 2>&1; then
            echo "AWS CLI not found. Installing..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
          else
            echo "AWS CLI already installed."
          fi
          aws --version

      - name: Ensure CDK bootstrapped
        run: |
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ vars.AWS_REGION }} >/dev/null 2>&1; then
            echo "CDKToolkit not found in ${{ vars.AWS_REGION }}. Bootstrapping..."
            pnpm --filter website-monitoring-infra run cdk bootstrap
          else
            echo "CDKToolkit exists in ${{ vars.AWS_REGION }}. Skipping bootstrap."
          fi

      - name: Build infrastructure
        run: pnpm --filter website-monitoring-infra run build

      - name: Get API URL from stack outputs
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name WebsiteMonitoringStack \
            --region ${{ vars.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='StatusEndpointUrl'].OutputValue" \
            --output text 2>/dev/null || echo "")
          if [ -z "$API_URL" ]; then
            echo "API URL not found, will be available after first deployment"
            echo "api_url=" >> $GITHUB_OUTPUT
          else
            echo "API URL: $API_URL"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi

      - name: Build webapp
        run: |
          if [ -n "${{ steps.get-api-url.outputs.api_url }}" ]; then
            echo "Building webapp with API URL: ${{ steps.get-api-url.outputs.api_url }}"
            VITE_STATUS_API_URL="${{ steps.get-api-url.outputs.api_url }}" pnpm --filter website-monitoring-webapp run build
          else
            echo "Building webapp without API URL (first deployment)"
            pnpm --filter website-monitoring-webapp run build
          fi

      - name: CDK Diff
        run: pnpm --filter website-monitoring-infra run cdk diff
        continue-on-error: true

      - name: CDK Deploy
        run: pnpm --filter website-monitoring-infra run cdk deploy --require-approval never

      - name: Get deployed API URL
        id: deployed-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name WebsiteMonitoringStack \
            --region ${{ vars.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='StatusEndpointUrl'].OutputValue" \
            --output text)
          echo "Deployed API URL: $API_URL"
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Rebuild webapp with deployed API URL
        if: steps.get-api-url.outputs.api_url == ''
        run: |
          echo "Rebuilding webapp with deployed API URL: ${{ steps.deployed-api-url.outputs.api_url }}"
          VITE_STATUS_API_URL="${{ steps.deployed-api-url.outputs.api_url }}" pnpm --filter website-monitoring-webapp run build

      - name: Output deployment info
        run: |
          echo "Deployment completed successfully"
          pnpm --filter website-monitoring-infra run cdk ls
